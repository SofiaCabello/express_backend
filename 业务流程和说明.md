# 业务流程和说明

## 面向所有前端

所有条形码生成的逻辑由前端负责。

## 客户端

### 前置业务流程：注册和登录

1. 用户注册。

   调用`customer/sendEmailVerifyCode`发送邮箱验证码，调用`customer/register`验证邮箱验证码正确性并注册。**返回的JSON Web Token应当被存储在前端，并在前端发出的所有request的请求头中添加JWT。**

2. 用户登录。

   调用`customer/login`利用邮箱登录。**返回的JSON Web Token应当被存储在前端，并在前端发出的所有request的请求头中添加JWT。**

### 辅助业务流程：客户地址簿



### 核心业务流程：下单

1. 用户创建运单。

   调用`shipment/createShipment`[1]来创建运单。

   涉及`CreateShipmentDTO`

   ```Java
   public class CreateShipmentDTO implements Serializable {
       private Integer origin; // 出发地编号
       private Integer destination;    // 目的地编号
       private Integer customerId; // 客户ID
       private Integer type;   // 0: 标快，1: 特快
       private String payMethod;   // "cod_pending": 货到付款，"pending": 预先支付
   }
   ```

2. 用户向运单添加包裹。**注意，一个运单可以添加多个包裹，它们有独立的包裹ID，但目的地和出发地应当相同。**

   调用`package/createPackage`[2]来创建包裹。调用`package/calculatePrice`来为单个包裹计算预期价格，这个价格**不作为最终结果**，仅作面向用户展示。**应当在前端用户点击确认完成运单和包裹创建后，再向上述[1]、[2]发送请求**。

   涉及`CreatePackageDTO`

   ```java
   public class CreatePackageDTO implements Serializable {
       private Integer shipmentId; // 运单id
       private Integer receiverId; // 收件人id（如果在数据库中存在）
       private String receiverName;    // 收件人姓名
       private String receiverAddress; // 收件人地址
       private String receiverPhone;   // 收件人电话
       private Double weight;  // 包裹重量，单位kg
       private String size;    // 包裹尺寸，如 20,30,40 单位cm
   }
   ```
   
   `CalculatePriceDTO`
   
   ```java
   public class CalculatePriceDTO {
       private Integer origin; // 出发地编号
       private Integer destination;    // 目的地编号
       private Double weight;  // 包裹重量，单位kg
       private String size;    // 包裹尺寸，如 20,30,40 单位cm
       private Integer type;   // 包裹类型，0为标快，1为特快
   }
   ```
   
   包裹的尺寸单位为cm，按`长,宽,高`构建字符串。
   
   `type`中，`0`为标快，`1`为特快。

### 辅助业务流程：查询

1. 查询运单和附属包裹信息。

   调用`shipment/getShipmentInfo`来获取运单和包裹的信息。

2. 查询特定包裹地理位置历史信息。

   调用`package/getPackageLocation`来获取特定包裹的位置历史信息。



## 员工端：底层网点类

### 核心业务流程：揽收





## 员工端：转运类

### 核心业务流程：转运

1. 创建转运批次。

   调用`batch/createBatch`来创建转运批次，确定该批次的载具信息，并且设定负责人（负责人应当随同载具移动）。

2. 转运过程中。

   **定时**调用`vehicle/updateCoordinate`来更新载具位置信息。该过程会同步更新载具上的包裹的信息。

3. 更新批次状态。

   调用`batch/updateBatchStatus`来更新批次状态（转运中/已到达）。



